<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø´ÙˆØ§Ù‡Ø¯ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</title>
  <style>
    :root{
      --bg:#f1fbf1; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#0f7a3a; --border:#dbe7db; --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; color:var(--text); background:linear-gradient(180deg,#ffffff 0%, var(--bg) 60%, #ffffff 100%); font-size:24px;}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      position:sticky; top:0; z-index:5;
      background:#fff; border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1300px; margin:0 auto; padding:14px 16px;}
    .brand{display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .brand h1{font-size:30px; margin:0; font-weight:900;}
    .brand .sub{font-size:18px; color:var(--muted); line-height:1.5}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button,.btn{
      border:1px solid var(--border); background:#fff; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      box-shadow: 0 3px 10px rgba(2,6,23,.06);
      font-weight:600;
    }
    button.primary{background:var(--primary); color:#fff; border-color:transparent}
    button.danger{background:#b42318;color:#fff;border-color:transparent}
    button:disabled{opacity:.6; cursor:not-allowed}

    main{max-width:1300px; margin:0 auto; padding:18px 16px 40px;}
    .grid{display:grid; grid-template-columns: 320px 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .panel .hd{padding:14px 14px 10px; border-bottom:1px solid var(--border)}
    .panel .hd h2{margin:0;font-size:24px}
    .panel .bd{padding:12px 14px}

    .domain-list{display:flex; flex-direction:column; gap:8px}
    .domain-item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border:1px solid var(--border); border-radius:14px; cursor:pointer;
      background:#fff;
    }
    .domain-item.active{outline:2px solid rgba(15,122,58,.20); border-color:rgba(15,122,58,.35)}
    .domain-item small{color:var(--muted)}

    .search{display:flex; gap:8px; align-items:center}
    input[type="text"], textarea, select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#fff; color:var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:#fff}

    .cards{display:flex; flex-direction:column; gap:10px}
    .card{background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow: 0 10px 25px rgba(2,6,23,.06)}
    .card .top{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .meta{display:flex; flex-direction:column; gap:4px}
    .code{font-weight:800; letter-spacing:.5px}
    .std{font-size:20px; color:var(--muted)}
    .card .content{padding:12px 14px}
    .indicator{white-space:pre-wrap; line-height:1.7}

    .evidence{margin-top:10px; padding-top:10px; border-top:1px dashed var(--border)}
    .evidence-hd{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap}
    .ev-grid{display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; margin-top:10px}
    @media (max-width: 980px){ .ev-grid{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 560px){ .ev-grid{grid-template-columns: 1fr;} }

    .ev{
      border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#fff;
      display:flex; flex-direction:column;
    }
    .thumb{height:140px; background:#f2f6f2; display:flex; align-items:center; justify-content:center; color:var(--muted); position:relative}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .thumb .tag{position:absolute; bottom:8px; left:8px; background:rgba(15,122,58,.92); color:#fff; font-size:11px; padding:4px 8px; border-radius:999px}
    .ev .info{padding:10px 10px 12px; display:flex; flex-direction:column; gap:6px}
    .ev .title{font-weight:800; font-size:22px; line-height:1.4}
    .ev .sub{font-size:20px; color:var(--muted)}
    .ev .row{display:flex; gap:8px; flex-wrap:wrap}
    .ev .row button{padding:8px 10px; border-radius:12px; font-weight:700; box-shadow:none}

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; z-index:50; padding:18px}
    .modal.show{display:flex}
    .dialog{width:min(980px, 100%); background:#fff; border-radius:18px; border:1px solid var(--border); box-shadow:var(--shadow); overflow:hidden}
    .dialog .dh{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:10px}
    .dialog .dh strong{font-size:14px}
    .dialog .db{padding:14px}
    .close{background:#fff}
    .viewer{width:100%; height:70vh; border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#f7faf7}
    .viewer iframe,.viewer embed{width:100%; height:100%; border:0}

    .hint{color:var(--muted); font-size:18px; line-height:1.7}
    .toast{position:fixed; bottom:16px; right:16px; background:#0b1220; color:#fff; padding:10px 12px; border-radius:12px; display:none; z-index:60; max-width:360px}
    .toast.show{display:block}

    .split{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 900px){ .split{grid-template-columns:1fr} }

    .tiny{font-size:18px; color:var(--muted)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:18px; border:1px solid var(--border); padding:2px 6px; border-radius:8px; background:#fff}
      .masthead{font-weight:900; font-size:26px; line-height:1.6; margin-bottom:10px}
    .masthead-box{
      background: linear-gradient(135deg, #ffffff 0%, #e8f7ea 60%, #ffffff 100%);
      border:1px solid rgba(15,122,58,.18);
      border-radius:16px;
      padding:12px 14px;
      box-shadow:
        0 14px 28px rgba(2,6,23,.10),
        inset 0 1px 0 rgba(255,255,255,.75),
        inset 0 -6px 14px rgba(15,122,58,.08);
    }
    .masthead-line{display:block}
    .masthead-line + .masthead-line{margin-top:4px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div>
        <div class="masthead masthead-box">
          <span class="masthead-line">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</span>
          <span class="masthead-line">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</span>
          <span class="masthead-line">Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø© ÙˆØ§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†</span>
          <span class="masthead-line">ÙØ±ÙŠÙ‚ Ø§Ù„ØªÙ…ÙŠØ²</span>
          <span class="masthead-line">Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ù†ÙˆØ±Ø© Ø§Ù„Ø±ÙØ§Ø¹ÙŠ</span>
        </div>
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø´ÙˆØ§Ù‡Ø¯ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</h1>
        <div class="sub">Ù…Ù†ØµØ© Ù…Ø­Ù„ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±) Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ Ù„ÙƒÙ„ Ù…Ø¤Ø´Ø± â€” Ø±ÙˆØ§Ø¨Ø· / ØµÙˆØ± / Ù…Ù„ÙØ§Øª â€” Ù…Ø¹ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ.</div>
      </div>
      <div class="actions">
        <button class="primary" id="btnAddIndicator">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±</button>
        <button id="btnExport">ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© (JSON)</button>
        <label class="btn" style="display:inline-flex;align-items:center;gap:8px">
          Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </label>
        <button class="danger" id="btnReset">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <aside class="panel">
      <div class="hd">
        <h2>Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª</h2>
      </div>
      <div class="bd">
        <div class="domain-list" id="domainList"></div>
        <div style="margin-top:12px" class="hint">
          <div class="pill">ğŸ’¾ Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: <span class="kbd">LocalStorage</span> + <span class="kbd">IndexedDB</span></div>
          <div style="margin-top:8px">Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø£Ø¬Ù‡Ø²Ø©/Ù…ØªØµÙØ­Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ø§Ø³ØªØ®Ø¯Ù…ÙŠ <b>ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯</b>.</div>
        </div>
      </div>
    </aside>

    <section class="panel">
      <div class="hd">
        <div class="toolbar">
          <div style="flex:1" class="search">
            <input type="text" id="q" placeholder="Ø§Ø¨Ø­Ø«ÙŠ Ø¨Ø±Ù…Ø² Ø§Ù„Ù…Ø¤Ø´Ø± Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ø¹ÙŠØ§Ø±/Ø§Ù„Ù…Ø¤Ø´Ø±..." />
          </div>
          <div class="pill" id="stat"></div>
        </div>
      </div>
      <div class="bd">
        <div class="cards" id="cards"></div>
        <div class="hint" id="empty" style="display:none; padding:12px; border:1px dashed var(--border); border-radius:14px">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬. Ø¬Ø±Ù‘Ø¨ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø¬Ø¯ÙŠØ¯.
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Modal: Add/Edit Indicator -->
<div class="modal" id="mIndicator">
  <div class="dialog">
    <div class="dh">
      <strong id="mIndicatorTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±</strong>
      <button class="close" id="closeIndicator">âœ•</button>
    </div>
    <div class="db">
      <div class="split">
        <div>
          <label class="tiny">Ø§Ù„Ù…Ø¬Ø§Ù„</label>
          <select id="fDomain"></select>
        </div>
        <div>
          <label class="tiny">Ø§Ù„Ù…Ø¹ÙŠØ§Ø± (Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø±)</label>
          <input type="text" id="fStandard" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØªØ®Ø·ÙŠØ·" />
        </div>
      </div>
      <div class="split" style="margin-top:10px">
        <div>
          <label class="tiny">Ø±Ù…Ø² Ø§Ù„Ù…Ø¤Ø´Ø±</label>
          <input type="text" id="fCode" placeholder="Ù…Ø«Ø§Ù„: 1-1-1-1" />
        </div>
        <div>
          <label class="tiny">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¤Ø´Ø± (Ù…Ø®ØªØµØ±)</label>
          <input type="text" id="fIndicatorTitle" placeholder="Ù…Ø«Ø§Ù„: ØªØ¶Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø®Ø·Ø© ØªØ´ØºÙŠÙ„ÙŠØ©..." />
        </div>
      </div>
      <div style="margin-top:10px">
        <label class="tiny">ÙˆØµÙ Ø§Ù„Ù…Ø¤Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="fIndicatorDesc" placeholder="ÙŠÙ…ÙƒÙ†ÙƒÙ Ù„ØµÙ‚ ÙˆØµÙ Ø§Ù„Ù…Ø¤Ø´Ø± Ù‡Ù†Ø§..."></textarea>
      </div>
      <div style="margin-top:10px">
        <label class="tiny">ÙˆØ«Ø§Ø¦Ù‚ Ù…Ù‚ØªØ±Ø­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="fSuggested" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© ..."></textarea>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start">
        <button class="primary" id="saveIndicator">Ø­ÙØ¸</button>
        <button id="cancelIndicator">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div class="hint" style="margin-top:10px">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¨Ø¹Ø¶ Ù†ØµÙˆØµ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ØºÙŠØ± Ù…Ù†Ø³Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ù…Ù† PDF)ØŒ ÙŠÙ…ÙƒÙ†ÙƒÙ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù‡Ù†Ø§.
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add Evidence -->
<div class="modal" id="mEvidence">
  <div class="dialog">
    <div class="dh">
      <strong id="mEvidenceTitle">Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ù‡Ø¯</strong>
      <button class="close" id="closeEvidence">âœ•</button>
    </div>
    <div class="db">
      <div class="split">
        <div>
          <label class="tiny">Ù†ÙˆØ¹ Ø§Ù„Ø´Ø§Ù‡Ø¯</label>
          <select id="evType">
            <option value="link">Ø±Ø§Ø¨Ø·</option>
            <option value="file">Ù…Ù„Ù/ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²</option>
          </select>
        </div>
        <div>
          <label class="tiny">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø§Ù‡Ø¯</label>
          <input type="text" id="evTitle" placeholder="Ù…Ø«Ø§Ù„: ØµÙˆØ±Ø© ØªÙ†ÙÙŠØ° Ù†Ø´Ø§Ø·" />
        </div>
      </div>

      <div id="evLinkBox" style="margin-top:10px">
        <label class="tiny">Ø§Ù„Ø±Ø§Ø¨Ø·</label>
        <input type="text" id="evUrl" placeholder="https://..." />
        <div class="hint">Ø³ÙŠÙÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯.</div>
      </div>

      <div id="evFileBox" style="margin-top:10px; display:none">
        <label class="tiny">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù/ØµÙˆØ±Ø©</label>
        <input type="file" id="evFile" />
        <div class="hint">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (IndexedDB) Ø«Ù… ØªØ³ØªØ·ÙŠØ¹ÙŠÙ† Ø§Ø³ØªØ¹Ø±Ø§Ø¶Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>
      </div>

      <div style="margin-top:10px">
        <label class="tiny">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="evNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø®ØªØµØ±Ø©..."></textarea>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start">
        <button class="primary" id="saveEvidence">Ø¥Ø¶Ø§ÙØ©</button>
        <button id="cancelEvidence">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Viewer -->
<div class="modal" id="mViewer">
  <div class="dialog">
    <div class="dh">
      <strong id="viewerTitle">Ø§Ø³ØªØ¹Ø±Ø§Ø¶</strong>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button id="viewerOpen">ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯</button>
        <button class="close" id="closeViewer">âœ•</button>
      </div>
    </div>
    <div class="db">
      <div class="viewer" id="viewer"></div>
      <div class="hint" id="viewerHint" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/**********************
 * Storage + DB Layer
 **********************/
const APP_KEY = 'schoolEvidenceApp:v1';
const DB_NAME = 'schoolEvidenceBlobs:v1';
const DB_STORE = 'blobs';

function uuid(){
  return (crypto?.randomUUID?.() || ('id-' + Math.random().toString(16).slice(2) + Date.now()));
}

function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2600);
}

function loadState(){
  try{
    const raw = localStorage.getItem(APP_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}

function saveState(){
  localStorage.setItem(APP_KEY, JSON.stringify(state));
}

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        db.createObjectStore(DB_STORE, { keyPath: 'id' });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

async function putBlob(record){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE,'readwrite');
    tx.objectStore(DB_STORE).put(record);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}

async function getBlob(id){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE,'readonly');
    const req = tx.objectStore(DB_STORE).get(id);
    req.onsuccess = ()=> resolve(req.result || null);
    req.onerror = ()=> reject(req.error);
  });
}

async function deleteBlob(id){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE,'readwrite');
    tx.objectStore(DB_STORE).delete(id);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}

/**********************
 * Seed (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§)
 **********************/
const DOMAIN_ORDER = [
  { key:'admin', name:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©' },
  { key:'teach', name:'Ù…Ø¬Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù…' },
  { key:'outcomes', name:'Ù…Ø¬Ø§Ù„ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù…' },
  { key:'env', name:'Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©' },
];

// Ù…Ø¤Ø´Ø±Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ© (Ù…Ø®ØªØµØ±Ø©) â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„/Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±Ø§Øª Ù…Ù† Ø²Ø± (Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±)
// Ø¥Ø°Ø§ Ø£Ø±Ø¯ØªÙ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©: Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±/Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø¹Ø¯ ØªØ¬Ù‡ÙŠØ² JSON.
const SEED = {
  version: 1,
  activeDomain: 'admin',
  domains: {
    admin: { name: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©', indicators: [
      { id: uuid(), standard: 'Ø§Ù„ØªØ®Ø·ÙŠØ·', code: '1-1-1-1', title: 'ØªØ¶Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø®Ø·Ø© ØªØ´ØºÙŠÙ„ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆÙÙ‚ Ø£Ù‡Ø¯Ø§Ù ØªØ·ÙˆÙŠØ±ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©.', desc: '', suggested: '' },
      { id: uuid(), standard: 'Ø§Ù„ØªØ®Ø·ÙŠØ·', code: '1-1-1-2', title: 'ØªØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØªÙ†ÙÙŠØ° Ø®Ø·ØªÙ‡Ø§ ÙˆØªØ·ÙˆÙŠØ±Ù‡Ø§ Ø¨Ù…Ø§ ÙŠØ¶Ù…Ù† ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‡Ø¯Ø§ÙÙ‡Ø§.', desc: '', suggested: '' },
      { id: uuid(), standard: 'Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©', code: '1-2-1-4', title: 'ØªÙ†Ø´Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©ØŒ ÙˆØªØªØ§Ø¨Ø¹ ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§.', desc: '', suggested: '' },
    ]},
    teach: { name: 'Ù…Ø¬Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„ØªØ¹Ù„Ù…', indicators: [
      { id: uuid(), standard: 'Ø¨Ù†Ø§Ø¡ Ø®Ø¨Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…', code: '2-1-1-3', title: 'ØªÙ†ÙˆØ¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³ Ù„ØªÙ„Ø¨ÙŠØ© Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø£Ø·ÙØ§Ù„.', desc: '', suggested: '' },
      { id: uuid(), standard: 'ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØªØ¹Ù„Ù…', code: '2-2-1-1', title: 'ØªØ·Ø¨Ù‚ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£Ø³Ø§Ù„ÙŠØ¨ ØªÙ‚ÙˆÙŠÙ… Ù…ØªÙ†ÙˆØ¹Ø© ÙˆÙØ§Ø¹Ù„Ø© Ù„ØªÙ‚ÙˆÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†.', desc: '', suggested: '' },
    ]},
    outcomes: { name: 'Ù…Ø¬Ø§Ù„ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù…', indicators: [
      { id: uuid(), standard: 'Ù†Ù…Ùˆ Ø®Ø¨Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…', code: '3-1-1-1', title: 'ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØªÙ‚Ø¯Ù…Ø§Ù‹ ÙÙŠ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø·ÙØ§Ù„ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ù†Ù…Ø§Ø¦ÙŠØ©.', desc: '', suggested: '' },
    ]},
    env: { name: 'Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©', indicators: [
      { id: uuid(), standard: 'ØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© ØªØ¹Ù„Ù… Ø¢Ù…Ù†Ø© ÙˆØ¯Ø§Ø¹Ù…Ø©', code: '4-1-1-1', title: 'ØªÙˆÙØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨ÙŠØ¦Ø© ØµÙÙŠØ© ÙˆØºØ±Ù Ù…ØµØ§Ø¯Ø± Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØ¢Ù…Ù†Ø©.', desc: '', suggested: '' },
    ]},
  },
  // evidence map: indicatorId -> list
  evidence: {}
};

let state = loadState() || structuredClone(SEED);

/**********************
 * UI Rendering
 **********************/
const $ = (sel)=>document.querySelector(sel);
const domainList = $('#domainList');
const cards = $('#cards');
const q = $('#q');
const stat = $('#stat');
const empty = $('#empty');

function countEvidence(indicatorId){
  return (state.evidence[indicatorId] || []).length;
}

function renderDomains(){
  domainList.innerHTML = '';
  DOMAIN_ORDER.forEach(d=>{
    const domain = state.domains[d.key];
    const el = document.createElement('div');
    el.className = 'domain-item' + (state.activeDomain===d.key?' active':'');
    const count = domain?.indicators?.length || 0;
    el.innerHTML = `
      <div>
        <div style="font-weight:900">${domain?.name || d.name}</div>
        <small>${count} Ù…Ø¤Ø´Ø±</small>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <span class="pill" title="Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ø§Ù„">ğŸ“ ${countDomainEvidence(d.key)}</span>
      </div>
    `;
    el.onclick = ()=>{ state.activeDomain = d.key; saveState(); render(); };
    domainList.appendChild(el);
  });
}

function countDomainEvidence(domainKey){
  const domain = state.domains[domainKey];
  if(!domain) return 0;
  return (domain.indicators||[]).reduce((acc,it)=>acc + countEvidence(it.id), 0);
}

function normalizeText(s){
  return (s||'').toLowerCase().replace(/\s+/g,' ').trim();
}

function renderCards(){
  const domain = state.domains[state.activeDomain];
  const query = normalizeText(q.value);

  const list = (domain?.indicators || []).filter(it=>{
    if(!query) return true;
    const blob = normalizeText([it.code,it.standard,it.title,it.desc,it.suggested].join(' '));
    return blob.includes(query);
  });

  stat.textContent = `${domain?.name || ''} â€” ${list.length} / ${(domain?.indicators||[]).length} Ù…Ø¤Ø´Ø±`;

  cards.innerHTML = '';
  empty.style.display = list.length ? 'none' : 'block';

  list
    .sort((a,b)=> (a.code||'').localeCompare(b.code||'','ar'))
    .forEach(it=>{
      const evCount = countEvidence(it.id);
      const c = document.createElement('div');
      c.className = 'card';
      c.innerHTML = `
        <div class="top">
          <div class="meta">
            <div class="code">${escapeHtml(it.code||'')}</div>
            <div class="std">Ø§Ù„Ù…Ø¹ÙŠØ§Ø±: ${escapeHtml(it.standard||'â€”')}</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button data-act="addEv">+ Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ù‡Ø¯</button>
            <button data-act="edit">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="danger" data-act="del">Ø­Ø°Ù</button>
          </div>
        </div>
        <div class="content">
          <div class="indicator"><b>${escapeHtml(it.title||'')}</b>${it.desc?`\n\n${escapeHtml(it.desc)}`:''}</div>
          ${it.suggested?`<div class="hint" style="margin-top:10px"><b>ÙˆØ«Ø§Ø¦Ù‚ Ù…Ù‚ØªØ±Ø­Ø©:</b> ${escapeHtml(it.suggested)}</div>`:''}

          <div class="evidence">
            <div class="evidence-hd">
              <div class="pill">ğŸ“ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯: <b>${evCount}</b></div>
              <div class="hint">Ø¥Ø±ÙØ§Ù‚ Ø±Ø§Ø¨Ø· / ØµÙˆØ±Ø© / Ù…Ù„Ù â€” Ù…Ø¹ Ø§Ù„Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†ØµØ©</div>
            </div>
            <div class="ev-grid" id="ev-${it.id}"></div>
          </div>
        </div>
      `;

      // actions
      c.querySelector('[data-act="addEv"]').onclick = ()=> openEvidenceModal(it.id);
      c.querySelector('[data-act="edit"]').onclick = ()=> openIndicatorModal(it);
      c.querySelector('[data-act="del"]').onclick = ()=> deleteIndicator(it.id);

      cards.appendChild(c);
      renderEvidenceGrid(it.id);
    });
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"]/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
}

async function renderEvidenceGrid(indicatorId){
  const grid = document.getElementById(`ev-${indicatorId}`);
  if(!grid) return;
  const list = state.evidence[indicatorId] || [];
  grid.innerHTML = '';

  if(list.length===0){
    const msg = document.createElement('div');
    msg.className = 'hint';
    msg.style.gridColumn = '1 / -1';
    msg.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙˆØ§Ù‡Ø¯ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ·ÙŠ "+ Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ù‡Ø¯".';
    grid.appendChild(msg);
    return;
  }

  for(const ev of list){
    const el = document.createElement('div');
    el.className = 'ev';

    let thumb = `<div class="thumb"><div>ğŸ“</div><span class="tag">${ev.type==='link'?'Ø±Ø§Ø¨Ø·':'Ù…Ù„Ù'}</span></div>`;

    if(ev.type==='file' && ev.mime && ev.mime.startsWith('image/')){
      // Use Blob URL (async)
      const rec = await getBlob(ev.blobId);
      if(rec?.blob){
        const url = URL.createObjectURL(rec.blob);
        thumb = `<div class="thumb"><img alt="" src="${url}"><span class="tag">ØµÙˆØ±Ø©</span></div>`;
        // revoke later to keep UI responsive
        setTimeout(()=> URL.revokeObjectURL(url), 10000);
      }
    }

    el.innerHTML = `
      ${thumb}
      <div class="info">
        <div class="title">${escapeHtml(ev.title || (ev.type==='link'? 'Ø±Ø§Ø¨Ø·' : (ev.name || 'Ù…Ù„Ù')))}</div>
        <div class="sub">${escapeHtml(ev.type==='link'? ev.url : (ev.name || ev.mime || ''))}</div>
        ${ev.notes?`<div class="sub">ğŸ“ ${escapeHtml(ev.notes)}</div>`:''}
        <div class="row">
          <button data-act="view">Ø§Ø³ØªØ¹Ø±Ø§Ø¶</button>
          <button data-act="open">ÙØªØ­</button>
          <button class="danger" data-act="remove">Ø­Ø°Ù</button>
        </div>
      </div>
    `;

    el.querySelector('[data-act="view"]').onclick = ()=> viewEvidence(ev);
    el.querySelector('[data-act="open"]').onclick = ()=> openEvidence(ev);
    el.querySelector('[data-act="remove"]').onclick = ()=> removeEvidence(indicatorId, ev.id);

    grid.appendChild(el);
  }
}

function render(){
  renderDomains();
  renderCards();
}

/**********************
 * Indicator CRUD
 **********************/
let editingIndicatorId = null;

function openIndicatorModal(indicator=null){
  editingIndicatorId = indicator?.id || null;

  $('#mIndicatorTitle').textContent = indicator ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¤Ø´Ø±' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±';

  // domains select
  const sel = $('#fDomain');
  sel.innerHTML = '';
  DOMAIN_ORDER.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = d.key;
    opt.textContent = state.domains[d.key]?.name || d.name;
    sel.appendChild(opt);
  });
  sel.value = indicator ? findIndicatorDomain(indicator.id) : state.activeDomain;

  $('#fStandard').value = indicator?.standard || '';
  $('#fCode').value = indicator?.code || '';
  $('#fIndicatorTitle').value = indicator?.title || '';
  $('#fIndicatorDesc').value = indicator?.desc || '';
  $('#fSuggested').value = indicator?.suggested || '';

  showModal('mIndicator');
}

function findIndicatorDomain(indicatorId){
  for(const d of DOMAIN_ORDER){
    const domain = state.domains[d.key];
    if((domain?.indicators||[]).some(x=>x.id===indicatorId)) return d.key;
  }
  return state.activeDomain;
}

function upsertIndicator(){
  const domainKey = $('#fDomain').value;
  const code = $('#fCode').value.trim();
  const standard = $('#fStandard').value.trim();
  const title = $('#fIndicatorTitle').value.trim();
  const desc = $('#fIndicatorDesc').value.trim();
  const suggested = $('#fSuggested').value.trim();

  if(!code || !title){
    toast('ÙØ¶Ù„Ø§Ù‹: Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù…Ø² Ø§Ù„Ù…Ø¤Ø´Ø± + Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¤Ø´Ø±');
    return;
  }

  // If editing: remove from old domain first
  if(editingIndicatorId){
    const oldDomain = findIndicatorDomain(editingIndicatorId);
    const oldList = state.domains[oldDomain].indicators;
    const idx = oldList.findIndex(x=>x.id===editingIndicatorId);
    const obj = {
      id: editingIndicatorId,
      standard, code, title, desc, suggested,
    };
    if(idx>-1) oldList.splice(idx, 1);
    state.domains[domainKey].indicators.push(obj);
  } else {
    const obj = { id: uuid(), standard, code, title, desc, suggested };
    state.domains[domainKey].indicators.push(obj);
  }

  saveState();
  hideModal('mIndicator');
  render();
  toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
}

async function deleteIndicator(indicatorId){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø¤Ø´Ø± Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ØŸ')) return;

  // delete evidence blobs
  const evs = state.evidence[indicatorId] || [];
  for(const ev of evs){
    if(ev.type==='file' && ev.blobId){
      try{ await deleteBlob(ev.blobId); }catch{}
    }
  }
  delete state.evidence[indicatorId];

  // remove indicator
  const dKey = findIndicatorDomain(indicatorId);
  const list = state.domains[dKey].indicators;
  const idx = list.findIndex(x=>x.id===indicatorId);
  if(idx>-1) list.splice(idx,1);

  saveState();
  render();
  toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

/**********************
 * Evidence CRUD
 **********************/
let currentIndicatorForEvidence = null;

function openEvidenceModal(indicatorId){
  currentIndicatorForEvidence = indicatorId;
  $('#mEvidenceTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ù‡Ø¯ Ù„Ù„Ù…Ø¤Ø´Ø±';
  $('#evType').value = 'link';
  $('#evTitle').value = '';
  $('#evUrl').value = '';
  $('#evNotes').value = '';
  $('#evFile').value = '';
  toggleEvType();
  showModal('mEvidence');
}

function toggleEvType(){
  const type = $('#evType').value;
  $('#evLinkBox').style.display = type==='link' ? 'block' : 'none';
  $('#evFileBox').style.display = type==='file' ? 'block' : 'none';
}

async function addEvidence(){
  const type = $('#evType').value;
  const title = $('#evTitle').value.trim();
  const notes = $('#evNotes').value.trim();

  if(!currentIndicatorForEvidence){
    toast('Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¤Ø´Ø±');
    return;
  }

  const list = state.evidence[currentIndicatorForEvidence] ||= [];

  if(type==='link'){
    const url = $('#evUrl').value.trim();
    if(!url || !/^https?:\/\//i.test(url)){
      toast('ÙØ¶Ù„Ø§Ù‹: Ø£Ø¯Ø®Ù„ÙŠ Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http/https');
      return;
    }
    list.push({ id: uuid(), type:'link', title, url, notes, createdAt: new Date().toISOString() });
    saveState();
    hideModal('mEvidence');
    render();
    toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…');
    return;
  }

  // file
  const fileInput = $('#evFile');
  const file = fileInput.files?.[0];
  if(!file){
    toast('ÙØ¶Ù„Ø§Ù‹: Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù„ÙØ§Ù‹');
    return;
  }

  const blobId = uuid();
  await putBlob({ id: blobId, blob: file, name: file.name, mime: file.type || 'application/octet-stream', size: file.size, createdAt: new Date().toISOString() });

  list.push({
    id: uuid(), type:'file', title,
    blobId,
    name: file.name,
    mime: file.type || 'application/octet-stream',
    size: file.size,
    notes,
    createdAt: new Date().toISOString(),
  });

  saveState();
  hideModal('mEvidence');
  render();
  toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ âœ…');
}

async function removeEvidence(indicatorId, evidenceId){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù‡Ø¯ØŸ')) return;
  const list = state.evidence[indicatorId] || [];
  const idx = list.findIndex(x=>x.id===evidenceId);
  if(idx===-1) return;
  const ev = list[idx];
  list.splice(idx,1);
  if(ev.type==='file' && ev.blobId){
    try{ await deleteBlob(ev.blobId); }catch{}
  }
  saveState();
  render();
  toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

/**********************
 * Viewer / Open
 **********************/
let currentViewing = null;

function showModal(id){ document.getElementById(id).classList.add('show'); }
function hideModal(id){ document.getElementById(id).classList.remove('show'); }

function openEvidence(ev){
  if(ev.type==='link'){
    window.open(ev.url, '_blank', 'noopener,noreferrer');
    return;
  }
  // file
  viewEvidence(ev, true);
}

async function viewEvidence(ev, openInNewTab=false){
  currentViewing = ev;
  const viewer = $('#viewer');
  const hint = $('#viewerHint');
  const btnOpen = $('#viewerOpen');
  viewer.innerHTML = '';
  hint.textContent = '';

  if(ev.type==='link'){
    $('#viewerTitle').textContent = ev.title || 'Ø±Ø§Ø¨Ø·';
    const frame = document.createElement('iframe');
    frame.referrerPolicy = 'no-referrer';
    frame.src = ev.url;
    viewer.appendChild(frame);
    btnOpen.onclick = ()=> window.open(ev.url, '_blank', 'noopener,noreferrer');
    showModal('mViewer');
    if(openInNewTab) btnOpen.click();
    return;
  }

  const rec = await getBlob(ev.blobId);
  if(!rec?.blob){
    toast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­');
    return;
  }

  const url = URL.createObjectURL(rec.blob);
  $('#viewerTitle').textContent = ev.title || ev.name || 'Ù…Ù„Ù';

  btnOpen.onclick = ()=> window.open(url, '_blank', 'noopener');

  // Try to embed preview
  const mime = ev.mime || rec.mime || '';
  if(mime.startsWith('image/')){
    const img = document.createElement('img');
    img.src = url;
    img.style.width='100%';
    img.style.height='100%';
    img.style.objectFit='contain';
    viewer.appendChild(img);
  } else if(mime === 'application/pdf'){
    const embed = document.createElement('embed');
    embed.src = url;
    embed.type = 'application/pdf';
    viewer.appendChild(embed);
  } else {
    // fallback
    const box = document.createElement('div');
    box.style.padding='14px';
    box.className='hint';
    box.innerHTML = `Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹. Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø²Ø± <b>ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯</b> Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.`;
    viewer.appendChild(box);
    hint.textContent = `Ø§Ù„Ù†ÙˆØ¹: ${mime || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} â€” Ø§Ù„Ø§Ø³Ù…: ${ev.name || ''}`;
  }

  showModal('mViewer');
  if(openInNewTab) btnOpen.click();

  // revoke later
  setTimeout(()=> URL.revokeObjectURL(url), 120000);
}

/**********************
 * Export / Import / Reset
 **********************/
async function exportData(){
  // Export state + blobs? blobs cannot be easily exported in one json without base64.
  // We'll export ONLY metadata, with a note.
  const payload = {
    exportedAt: new Date().toISOString(),
    note: 'Ù‡Ø°Ø§ Ø§Ù„ØªØµØ¯ÙŠØ± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØµÙŠØ© ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙ‚Ø·. Ø§Ù„Ù…Ù„ÙØ§Øª/Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ IndexedDB Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ Ø¯Ø§Ø®Ù„ JSON ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ù„Ø¥Ø¹Ø§Ø¯Ø© Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª: Ø£Ø¹ÙŠØ¯ÙŠ Ø±ÙØ¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø¬Ø¯ÙŠØ¯.',
    state
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'school-evidence-export.json';
  a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 2000);
  toast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± âœ…');
}

function importData(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const parsed = JSON.parse(String(reader.result||''));
      if(parsed?.state?.domains && parsed?.state?.evidence){
        state = parsed.state;
        saveState();
        render();
        toast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…');
      } else {
        toast('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
      }
    }catch{
      toast('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
    }
  };
  reader.readAsText(file);
}

async function resetAll(){
  if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ù…Ù„ÙØ§Øª). Ù‡Ù„ Ø£Ù†ØªÙ Ù…ØªØ£ÙƒØ¯Ø©ØŸ')) return;

  // Clear localStorage
  localStorage.removeItem(APP_KEY);
  // Clear IndexedDB
  indexedDB.deleteDatabase(DB_NAME);

  state = structuredClone(SEED);
  saveState();
  render();
  toast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·');
}

/**********************
 * Wire up events
 **********************/
q.addEventListener('input', ()=> renderCards());

$('#btnAddIndicator').addEventListener('click', ()=> openIndicatorModal(null));
$('#saveIndicator').addEventListener('click', upsertIndicator);
$('#cancelIndicator').addEventListener('click', ()=> hideModal('mIndicator'));
$('#closeIndicator').addEventListener('click', ()=> hideModal('mIndicator'));

$('#evType').addEventListener('change', toggleEvType);
$('#saveEvidence').addEventListener('click', addEvidence);
$('#cancelEvidence').addEventListener('click', ()=> hideModal('mEvidence'));
$('#closeEvidence').addEventListener('click', ()=> hideModal('mEvidence'));

$('#closeViewer').addEventListener('click', ()=> hideModal('mViewer'));

$('#btnExport').addEventListener('click', exportData);
$('#importFile').addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(f) importData(f);
  e.target.value = '';
});

$('#btnReset').addEventListener('click', resetAll);

// Close modals on backdrop click
['mIndicator','mEvidence','mViewer'].forEach(id=>{
  const m = document.getElementById(id);
  m.addEventListener('click', (e)=>{ if(e.target===m) hideModal(id); });
});

render();
</script>
</body>
</html>
